<!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>&#x804a;&#x5929;&#x5ba4;&#x8bf4;&#x660e; &quot;Chatting Room&quot; Introduction</title>
            <style>
/* From extension vscode.github */
/*---------------------------------------------------------------------------------------------
 *  Copyright (c) Microsoft Corporation. All rights reserved.
 *  Licensed under the MIT License. See License.txt in the project root for license information.
 *--------------------------------------------------------------------------------------------*/

.vscode-dark img[src$=\#gh-light-mode-only],
.vscode-light img[src$=\#gh-dark-mode-only],
.vscode-high-contrast:not(.vscode-high-contrast-light) img[src$=\#gh-light-mode-only],
.vscode-high-contrast-light img[src$=\#gh-dark-mode-only] {
	display: none;
}

</style>
            
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/markdown.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
<style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe WPC', 'Segoe UI', system-ui, 'Ubuntu', 'Droid Sans', sans-serif;
                font-size: 14px;
                line-height: 1.6;
            }
        </style>
        <style>
.task-list-item {
    list-style-type: none;
}

.task-list-item-checkbox {
    margin-left: -20px;
    vertical-align: middle;
    pointer-events: none;
}
</style>
<style>
:root {
  --color-note: #0969da;
  --color-tip: #1a7f37;
  --color-warning: #9a6700;
  --color-severe: #bc4c00;
  --color-caution: #d1242f;
  --color-important: #8250df;
}

</style>
<style>
@media (prefers-color-scheme: dark) {
  :root {
    --color-note: #2f81f7;
    --color-tip: #3fb950;
    --color-warning: #d29922;
    --color-severe: #db6d28;
    --color-caution: #f85149;
    --color-important: #a371f7;
  }
}

</style>
<style>
.markdown-alert {
  padding: 0.5rem 1rem;
  margin-bottom: 16px;
  color: inherit;
  border-left: .25em solid #888;
}

.markdown-alert>:first-child {
  margin-top: 0
}

.markdown-alert>:last-child {
  margin-bottom: 0
}

.markdown-alert .markdown-alert-title {
  display: flex;
  font-weight: 500;
  align-items: center;
  line-height: 1
}

.markdown-alert .markdown-alert-title .octicon {
  margin-right: 0.5rem;
  display: inline-block;
  overflow: visible !important;
  vertical-align: text-bottom;
  fill: currentColor;
}

.markdown-alert.markdown-alert-note {
  border-left-color: var(--color-note);
}

.markdown-alert.markdown-alert-note .markdown-alert-title {
  color: var(--color-note);
}

.markdown-alert.markdown-alert-important {
  border-left-color: var(--color-important);
}

.markdown-alert.markdown-alert-important .markdown-alert-title {
  color: var(--color-important);
}

.markdown-alert.markdown-alert-warning {
  border-left-color: var(--color-warning);
}

.markdown-alert.markdown-alert-warning .markdown-alert-title {
  color: var(--color-warning);
}

.markdown-alert.markdown-alert-tip {
  border-left-color: var(--color-tip);
}

.markdown-alert.markdown-alert-tip .markdown-alert-title {
  color: var(--color-tip);
}

.markdown-alert.markdown-alert-caution {
  border-left-color: var(--color-caution);
}

.markdown-alert.markdown-alert-caution .markdown-alert-title {
  color: var(--color-caution);
}

</style>
        
        </head>
        <body class="vscode-body vscode-dark">
            <h1 id="聊天室说明-chatting-room-introduction">聊天室说明 &quot;Chatting Room&quot; Introduction</h1>
<blockquote>
<p>小组成员：鲍梓涵、陈海桥、王天亮</p>
</blockquote>
<hr>
<h2 id="0-目录">0. 目录</h2>
<ul>
<li><a href="#%E8%81%8A%E5%A4%A9%E5%AE%A4%E8%AF%B4%E6%98%8E-chatting-room-introduction">聊天室说明 &quot;Chatting Room&quot; Introduction</a>
<ul>
<li><a href="#0-%E7%9B%AE%E5%BD%95">0. 目录</a></li>
<li><a href="#1-%E6%8A%80%E6%9C%AF%E5%9F%BA%E7%A1%80">1. 技术基础</a>
<ul>
<li><a href="#11-%E6%9C%8D%E5%8A%A1%E7%AB%AF">1.1 服务端</a></li>
<li><a href="#12-%E5%AE%A2%E6%88%B7%E7%AB%AF">1.2 客户端</a></li>
</ul>
</li>
<li><a href="#2-%E4%BB%A3%E7%A0%81%E7%BB%84%E6%88%90">2. 代码组成</a>
<ul>
<li><a href="#21-%E5%8C%85%E5%90%AB%E5%A4%B4%E6%96%87%E4%BB%B6%E5%BA%93">2.1 包含头文件/库</a>
<ul>
<li><a href="#211-%E6%9C%8D%E5%8A%A1%E7%AB%AF">2.1.1 服务端</a></li>
<li><a href="#212-%E5%AE%A2%E6%88%B7%E7%AB%AF">2.1.2 客户端</a></li>
</ul>
</li>
<li><a href="#22-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84">2.2 数据结构</a>
<ul>
<li><a href="#221-%E6%9C%8D%E5%8A%A1%E7%AB%AF">2.2.1 服务端</a></li>
<li><a href="#222-%E5%AE%A2%E6%88%B7%E7%AB%AF">2.2.2 客户端</a></li>
</ul>
</li>
<li><a href="#23-%E9%83%A8%E5%88%86%E5%87%BD%E6%95%B0%E4%BB%8B%E7%BB%8D">2.3 部分函数介绍</a>
<ul>
<li><a href="#231-utf-8%E8%BD%ACgbk%E9%80%9A%E7%94%A8">2.3.1 UTF-8转GBK(通用)</a></li>
<li><a href="#232-%E8%8E%B7%E5%8F%96%E6%9C%AC%E6%9C%BAip%E9%80%9A%E7%94%A8">2.3.2 获取本机ip(通用)</a></li>
<li><a href="#233-%E9%AA%8C%E8%AF%81%E7%99%BB%E5%BD%95%E6%B3%A8%E5%86%8C%E6%9C%8D%E5%8A%A1%E7%AB%AF">2.3.3 验证登录/注册(服务端)</a></li>
<li><a href="#234-%E6%A0%B9%E6%8D%AEsocket%E5%88%A0%E9%99%A4%E5%9C%A8%E7%BA%BF%E7%94%A8%E6%88%B7%E6%9C%8D%E5%8A%A1%E7%AB%AF">2.3.4 根据Socket删除在线用户(服务端)</a></li>
<li><a href="#235-%E5%8F%91%E9%80%81%E8%BE%93%E5%87%BA%E7%BC%93%E5%86%B2%E5%8C%BA%E4%BF%A1%E6%81%AF%E8%87%B3%E5%9C%A8%E7%BA%BF%E7%94%A8%E6%88%B7%E6%9C%8D%E5%8A%A1%E7%AB%AF">2.3.5 发送输出缓冲区信息至在线用户(服务端)</a></li>
<li><a href="#236-%E6%8E%A5%E5%8F%97%E5%9C%A8%E7%BA%BF%E7%94%A8%E6%88%B7%E4%BF%A1%E6%81%AF%E5%AE%A2%E6%88%B7%E7%AB%AF">2.3.6 接受在线用户信息(客户端)</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#3-%E4%B8%BB%E8%A6%81%E5%8A%9F%E8%83%BD">3. 主要功能</a>
<ul>
<li><a href="#31-%E6%9C%8D%E5%8A%A1%E7%AB%AF">3.1 服务端</a></li>
<li><a href="#32-%E5%AE%A2%E6%88%B7%E7%AB%AF">3.2 客户端</a></li>
</ul>
</li>
<li><a href="#4-%E9%80%BB%E8%BE%91%E6%80%9D%E6%83%B3">4. 逻辑思想</a>
<ul>
<li><a href="#41-%E6%B3%A8%E5%86%8C">4.1 注册</a></li>
<li><a href="#42-%E7%99%BB%E5%BD%95">4.2 登录</a></li>
<li><a href="#43-%E8%81%8A%E5%A4%A9">4.3 聊天</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<hr>
<h2 id="1-技术基础">1. 技术基础</h2>
<p>本程序分为两个组成部分: 服务端&amp;客户端<br></p>
<h3 id="11-服务端">1.1 服务端</h3>
<ul>
<li>C语言</li>
<li>网络基础</li>
</ul>
<h3 id="12-客户端">1.2 客户端</h3>
<ul>
<li>C\C++语言</li>
<li>Qt窗口开发</li>
<li>网络基础</li>
</ul>
<hr>
<h2 id="2-代码组成">2. 代码组成</h2>
<h3 id="21-包含头文件库">2.1 包含头文件/库</h3>
<h4 id="211-服务端">2.1.1 服务端</h4>
<pre><code>- stdio.h		//输入输出
- iostream		//输入输出
- string.h		//字符串相关
- winsock2.h	//网络连接
- vector		//在线用户
- queue			//消息队列
- algorithm		//remove_if()函数删除在线用户
- Windows.h		//创建线程
- direct.h		//文件夹操作
- io.h			//文件夹操作
- ws2_32.lib	//Winsock依赖库
</code></pre>
<h4 id="212-客户端">2.1.2 客户端</h4>
<pre><code>- stdio.h						//输入输出
- iostream						//输入输出
- string						//字符串相关
- Windows.h						//创建线程
- winsock2.h					//网络连接
- qregularexpression			//限制输入格式
- QRegularExpressionValidator	//限制输入格式
- QtWidgets/QApplication		//创建QWidget对象
- qlistwidget.h					//创建QListWidget对象
- qstringlistmodel.h			//创建QStrigListModel对象
- ws2_32.lib					//Winsock依赖库
- cwchar						//宽字符转换
- cstring						//宽字符转换
</code></pre>
<h3 id="22-数据结构">2.2 数据结构</h3>
<h4 id="221-服务端">2.2.1 服务端<br></h4>
<pre><code class="language-C"><span class="hljs-comment">//存放输入数据</span>
<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> {</span>
SOCKET socket;							<span class="hljs-comment">//对应用户socket</span>
SOCKET c_socket;						<span class="hljs-comment">//对应用户socket2</span>
<span class="hljs-type">char</span>* client_ip;						<span class="hljs-comment">//用户ip地址</span>
<span class="hljs-type">char</span> username[username_length];			<span class="hljs-comment">//用户名</span>
} Data;

<span class="hljs-comment">//输入信息</span>
<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> {</span>
SOCKET sender_socket;					<span class="hljs-comment">//发送者socket</span>
<span class="hljs-type">char</span>* client_ip;						<span class="hljs-comment">//发送者ip</span>
<span class="hljs-type">char</span>* username;							<span class="hljs-comment">//发送者用户名</span>
<span class="hljs-built_in">string</span> message;							<span class="hljs-comment">//发送的信息</span>
} Messages;

<span class="hljs-built_in">vector</span>&lt;Data&gt; clients;     				<span class="hljs-comment">//在线人员列表</span>
<span class="hljs-built_in">queue</span>&lt;Messages&gt; messages; 				<span class="hljs-comment">//发送信息缓冲</span>

<span class="hljs-type">bool</span> status1 = <span class="hljs-literal">true</span>;  					<span class="hljs-comment">//是否有人正在连接</span>
<span class="hljs-type">bool</span> status2 = <span class="hljs-literal">true</span>;  					<span class="hljs-comment">//是否在发送信息</span>
<span class="hljs-type">const</span> <span class="hljs-type">int</span> username_length = <span class="hljs-number">1024</span>;		<span class="hljs-comment">//最大用户名长度</span>
<span class="hljs-type">const</span> <span class="hljs-type">int</span> password_length = <span class="hljs-number">1024</span>;		<span class="hljs-comment">//最大密码长度</span>
<span class="hljs-type">const</span> <span class="hljs-type">int</span> message_length = <span class="hljs-number">1024</span>;		<span class="hljs-comment">//最大消息长度</span>
<span class="hljs-type">const</span> <span class="hljs-type">int</span> line_len = <span class="hljs-number">120</span>;				<span class="hljs-comment">//DOS窗口宽度</span>
</code></pre>
<h4 id="222-客户端">2.2.2 客户端</h4>
<pre><code class="language-C++">std::string localip;					<span class="hljs-comment">//本地ip</span>
SOCKET client_socket, client_socket_c;	<span class="hljs-comment">//两个socket</span>
<span class="hljs-type">bool</span> connect_status = <span class="hljs-literal">true</span>;				<span class="hljs-comment">//是否连接成功</span>
<span class="hljs-type">int</span> client_count = <span class="hljs-number">0</span>;					<span class="hljs-comment">//在线用户数量</span>
<span class="hljs-type">char</span> e_server_ip[<span class="hljs-number">256</span>] = { <span class="hljs-number">0</span> };			<span class="hljs-comment">//服务器ip</span>
<span class="hljs-type">char</span> c_username[<span class="hljs-number">1024</span>] = { <span class="hljs-number">0</span> };			<span class="hljs-comment">//用户名(char)</span>
<span class="hljs-type">const</span> <span class="hljs-type">int</span> username_length = <span class="hljs-number">1024</span>;		<span class="hljs-comment">//最大用户名长度</span>
<span class="hljs-type">const</span> <span class="hljs-type">int</span> password_length = <span class="hljs-number">1024</span>;		<span class="hljs-comment">//最大密码长度</span>
<span class="hljs-type">const</span> <span class="hljs-type">int</span> message_length = <span class="hljs-number">1024</span>;		<span class="hljs-comment">//最大消息长度</span>
<span class="hljs-type">const</span> <span class="hljs-type">char</span>* status = <span class="hljs-string">&quot;login&quot;</span>;			<span class="hljs-comment">//登录界面状态</span>
</code></pre>
<h3 id="23-部分函数介绍">2.3 部分函数介绍</h3>
<h4 id="231-utf-8转gbk通用">2.3.1 UTF-8转GBK(通用)</h4>
<details><summary><mark>点击查看代码</mark></summary>
<pre><code class="language-C++"><span class="hljs-function"><span class="hljs-keyword">inline</span> string <span class="hljs-title">utg</span><span class="hljs-params">(<span class="hljs-type">const</span> string&amp; utf8Str)</span> </span>{
<span class="hljs-comment">// 首先计算需要的宽字符串长度</span>
<span class="hljs-type">int</span> wideLength = <span class="hljs-built_in">MultiByteToWideChar</span>(CP_UTF8, <span class="hljs-number">0</span>, utf8Str.<span class="hljs-built_in">c_str</span>(), <span class="hljs-number">-1</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>);
<span class="hljs-function">std::vector&lt;<span class="hljs-type">wchar_t</span>&gt; <span class="hljs-title">wideStr</span><span class="hljs-params">(wideLength)</span></span>;

<span class="hljs-comment">// 将UTF-8转换为宽字符串</span>
<span class="hljs-built_in">MultiByteToWideChar</span>(CP_UTF8, <span class="hljs-number">0</span>, utf8Str.<span class="hljs-built_in">c_str</span>(), <span class="hljs-number">-1</span>, &amp;wideStr[<span class="hljs-number">0</span>], wideLength);

<span class="hljs-comment">// 计算GBK字符串长度</span>
<span class="hljs-type">int</span> gbkLength = <span class="hljs-built_in">WideCharToMultiByte</span>(CP_ACP, <span class="hljs-number">0</span>, &amp;wideStr[<span class="hljs-number">0</span>], <span class="hljs-number">-1</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-number">0</span>, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);
<span class="hljs-function">std::vector&lt;<span class="hljs-type">char</span>&gt; <span class="hljs-title">gbkStr</span><span class="hljs-params">(gbkLength)</span></span>;

<span class="hljs-comment">// 将宽字符串转换为GBK字符串</span>
<span class="hljs-built_in">WideCharToMultiByte</span>(CP_ACP, <span class="hljs-number">0</span>, &amp;wideStr[<span class="hljs-number">0</span>], <span class="hljs-number">-1</span>, &amp;gbkStr[<span class="hljs-number">0</span>], gbkLength, <span class="hljs-literal">nullptr</span>, <span class="hljs-literal">nullptr</span>);

<span class="hljs-keyword">return</span> <span class="hljs-built_in">string</span>(gbkStr.<span class="hljs-built_in">begin</span>(), gbkStr.<span class="hljs-built_in">end</span>() - <span class="hljs-number">1</span>); <span class="hljs-comment">// 减去末尾的空字符</span>
}
</code></pre>
</details>
<h4 id="232-获取本机ip通用">2.3.2 获取本机ip(通用)</h4>
<details><summary><mark>点击查看代码</mark></summary>
<pre><code class="language-C"><span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> <span class="hljs-title function_">getlocalip</span><span class="hljs-params">()</span> {
	<span class="hljs-type">int</span> ret;
	<span class="hljs-type">char</span> hostname[<span class="hljs-number">256</span>] = { <span class="hljs-number">0</span> };
	ret = gethostname(hostname, <span class="hljs-keyword">sizeof</span>(hostname));
	hostent* host = gethostbyname(hostname);
	<span class="hljs-keyword">return</span> inet_ntoa(*(<span class="hljs-keyword">struct</span> in_addr*)*host-&gt;h_addr_list);
}
</code></pre>
</details>
<h4 id="233-验证登录注册服务端">2.3.3 验证登录/注册(服务端)</h4>
<details><summary><mark>点击查看代码</mark></summary>
<pre><code class="language-C++"><span class="hljs-comment">// 登录验证</span>
<span class="hljs-function">string <span class="hljs-title">check_data_login</span><span class="hljs-params">(<span class="hljs-type">char</span>* username, <span class="hljs-type">char</span>* password)</span> </span>{
    FILE* file = <span class="hljs-built_in">fopen</span>(DATABASE_USER_INFO, <span class="hljs-string">&quot;r&quot;</span>);
    FILE* fileb = <span class="hljs-built_in">fopen</span>(DATABASE_BAN_LIST, <span class="hljs-string">&quot;r&quot;</span>);
    <span class="hljs-comment">// 定义文件指针history_file，并通过fopen以只读方式打开历史消息文件（&quot;.data/messages.txt&quot;），若打开失败则返回&quot;reject&quot;</span>
    FILE* history_file = <span class="hljs-built_in">fopen</span>(DATABASE_MESSAGES, <span class="hljs-string">&quot;r&quot;</span>);
    <span class="hljs-keyword">if</span> (file == <span class="hljs-literal">NULL</span> || fileb == <span class="hljs-literal">NULL</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;reject&quot;</span>;
    }

    <span class="hljs-type">char</span> line[username_length];
    <span class="hljs-comment">//封禁检测</span>
    <span class="hljs-keyword">while</span> (<span class="hljs-built_in">fgets</span>(line, username_length, fileb) != <span class="hljs-literal">NULL</span>) {
        <span class="hljs-type">char</span> storedUsername[username_length];
        <span class="hljs-type">int</span> ret = <span class="hljs-built_in">sscanf</span>(line, <span class="hljs-string">&quot;%s&quot;</span>, storedUsername);
        storedUsername[<span class="hljs-built_in">strlen</span>(storedUsername)] = <span class="hljs-string">&#x27;\0&#x27;</span>;
        <span class="hljs-keyword">if</span> (ret &lt;= <span class="hljs-number">0</span>) {
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\rstr Error!\n&quot;</span>);
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\r/&gt;&quot;</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;reject&quot;</span>;
        }
        <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">strcmp</span>(storedUsername, username)) {
            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;ban&quot;</span>;
        }
    }
    <span class="hljs-comment">//账户存在检测</span>
    <span class="hljs-keyword">while</span> (<span class="hljs-built_in">fgets</span>(line, <span class="hljs-built_in">sizeof</span>(line), file) != <span class="hljs-literal">NULL</span>) {
        <span class="hljs-type">char</span> storedUsername[username_length];
        <span class="hljs-type">char</span> storedPassword[password_length];
        <span class="hljs-type">int</span> ret = <span class="hljs-built_in">sscanf</span>(line, <span class="hljs-string">&quot;%s %s&quot;</span>, storedUsername, storedPassword);
        <span class="hljs-keyword">if</span> (ret != <span class="hljs-number">2</span>) {
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\rstr Error!\n&quot;</span>);
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\r/&gt;&quot;</span>);
            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;reject&quot;</span>;
        }
        storedUsername[<span class="hljs-built_in">strlen</span>(storedUsername)] = <span class="hljs-string">&#x27;\0&#x27;</span>;
        storedPassword[<span class="hljs-built_in">strlen</span>(storedPassword)] = <span class="hljs-string">&#x27;\0&#x27;</span>;
        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">strcmp</span>(username, storedUsername) == <span class="hljs-number">0</span> &amp;&amp; <span class="hljs-built_in">strcmp</span>(password, storedPassword) == <span class="hljs-number">0</span>) {
            g_historyMessages.<span class="hljs-built_in">clear</span>();  <span class="hljs-comment">// 先清空全局变量中的历史消息列表（避免之前残留数据影响）</span>
            <span class="hljs-type">char</span> history_line[message_length];
            <span class="hljs-comment">// 使用fgets从history_file指向的历史消息文件中逐行读取消息，将每行消息存入g_historyMessages全局向量中</span>
            <span class="hljs-keyword">while</span> (<span class="hljs-built_in">fgets</span>(history_line, message_length, history_file) != <span class="hljs-literal">NULL</span>) {
                g_historyMessages.<span class="hljs-built_in">push_back</span>(history_line);
            }
            <span class="hljs-built_in">fclose</span>(history_file);  <span class="hljs-comment">// 完成历史消息读取后，关闭文件，释放资源</span>
            <span class="hljs-built_in">fclose</span>(file);
            <span class="hljs-built_in">fclose</span>(fileb);
            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;accept&quot;</span>;
        }
    }

    <span class="hljs-built_in">fclose</span>(file);
    <span class="hljs-built_in">fclose</span>(fileb);
    <span class="hljs-built_in">fclose</span>(history_file);
    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;reject&quot;</span>;
}
</code></pre>
</details>
<h4 id="234-根据socket删除在线用户服务端">2.3.4 根据Socket删除在线用户(服务端)</h4>
<details><summary><mark>点击查看代码</mark></summary>
<pre><code class="language-C++"><span class="hljs-comment">// 移除客户端连接相关信息</span>
<span class="hljs-function"><span class="hljs-type">void</span> <span class="hljs-title">remove_client</span><span class="hljs-params">(SOCKET target_socket)</span> </span>{
    clients.<span class="hljs-built_in">erase</span>(
        <span class="hljs-built_in">remove_if</span>(clients.<span class="hljs-built_in">begin</span>(), clients.<span class="hljs-built_in">end</span>(),
            [&amp;target_socket](<span class="hljs-type">const</span> Data&amp; s) {
                <span class="hljs-keyword">return</span> target_socket == s.socket;
            }), clients.<span class="hljs-built_in">end</span>()
    );
}
</code></pre>
</details>
<h4 id="235-发送输出缓冲区信息至在线用户服务端">2.3.5 发送输出缓冲区信息至在线用户(服务端)</h4>
<details><summary><mark>点击查看代码</mark></summary>
<pre><code class="language-C"><span class="hljs-comment">// 发送线程</span>
DWORD WINAPI <span class="hljs-title function_">Send</span><span class="hljs-params">(LPVOID lpThreadParameter)</span> {
    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) {
        <span class="hljs-keyword">if</span> (!messages.empty()) {
            <span class="hljs-comment">//向非分发信息的客户端发送消息缓冲池的消息</span>
            status1 = <span class="hljs-literal">false</span>;
            <span class="hljs-built_in">string</span> temp;
            temp.append(messages.front().username);
            temp.append(<span class="hljs-string">&quot;:&quot;</span>);
            temp.append(messages.front().message);
            writeMessageToDatabase(temp.c_str());
            <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;\r分发消息至:[ &quot;</span>;
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">auto</span>&amp; clt : clients) {
                <span class="hljs-comment">//如果是发送者，则跳过</span>
                <span class="hljs-keyword">if</span> (messages.front().sender_socket == clt.socket) {
                    <span class="hljs-keyword">continue</span>;
                }
                <span class="hljs-keyword">while</span> (!status2);
                send(clt.socket, temp.c_str(), username_length, <span class="hljs-number">0</span>);
                <span class="hljs-built_in">cout</span> &lt;&lt; clt.socket &lt;&lt; <span class="hljs-string">&quot; &quot;</span>;
            }
            <span class="hljs-built_in">cout</span> &lt;&lt; <span class="hljs-string">&quot;]&quot;</span> &lt;&lt; <span class="hljs-built_in">endl</span>;
            <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;\r/&gt;&quot;</span>);
            status1 = <span class="hljs-literal">true</span>;
            messages.pop();
        }
    }
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
</details>
<h4 id="236-接受在线用户信息客户端">2.3.6 接受在线用户信息(客户端)</h4>
<details><summary><mark>点击查看代码</mark></summary>
<pre><code class="language-C++"><span class="hljs-comment">//接收在线用户信息线程</span>
<span class="hljs-function">DWORD WINAPI <span class="hljs-title">Receive_clients</span><span class="hljs-params">(LPVOID lpThreadParameter)</span> </span>{
	<span class="hljs-keyword">struct</span> <span class="hljs-title class_">Q2type</span> data = *(<span class="hljs-keyword">struct</span> Q2type *)lpThreadParameter;	<span class="hljs-comment">//将传入的数据转化至结构体</span>
	QListWidget* message_list = data.message_list;				<span class="hljs-comment">//将结构体信息转化至QListWidget对象</span>
	QLabel *label_count = data.client_count;					<span class="hljs-comment">//将结构体信息转化至QListWidget对象</span>
	<span class="hljs-comment">//设置列表属性</span>
	message_list-&gt;<span class="hljs-built_in">setSpacing</span>(<span class="hljs-number">5</span>);
	message_list-&gt;<span class="hljs-built_in">setEditTriggers</span>(QAbstractItemView::NoEditTriggers);
	<span class="hljs-keyword">while</span> (connect_status);										<span class="hljs-comment">//等待连接成功,防止Socket未创建时调用recv函数报错</span>
	<span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>) {
		<span class="hljs-type">char</span> c_client_count[<span class="hljs-number">256</span>] = { <span class="hljs-number">0</span> };						
		<span class="hljs-built_in">recv</span>(client_socket_c, c_client_count, <span class="hljs-number">256</span>, <span class="hljs-number">0</span>);			<span class="hljs-comment">//接收人数</span>
		c_list.<span class="hljs-built_in">clear</span>();	
		message_list-&gt;<span class="hljs-built_in">clear</span>();
		client_count = <span class="hljs-built_in">charToint</span>(c_client_count);				<span class="hljs-comment">//人数charToInt</span>
		label_count-&gt;<span class="hljs-built_in">setText</span>(c_client_count);					<span class="hljs-comment">//显示人数</span>
		<span class="hljs-type">char</span> info[username_length] = { <span class="hljs-number">0</span> };						<span class="hljs-comment">//建立用户列表</span>
		<span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> i = <span class="hljs-number">0</span>; i &lt; client_count; i++) {				
			<span class="hljs-built_in">recv</span>(client_socket_c, info, username_length, <span class="hljs-number">0</span>);	<span class="hljs-comment">//读取用户名</span>
			c_list.<span class="hljs-built_in">append</span>(info);								<span class="hljs-comment">//向列表加入用户</span>
		}
		QStringListModel* c_listmodel = <span class="hljs-keyword">new</span> <span class="hljs-built_in">QStringListModel</span>(c_list);
		message_list-&gt;<span class="hljs-built_in">addItems</span>(c_list);							<span class="hljs-comment">//显示列表</span>
	}
}
</code></pre>
</details>
<hr>
<h2 id="3-主要功能">3. 主要功能</h2>
<h3 id="31-服务端">3.1 服务端</h3>
<ol class="contains-task-list">
<li class="task-list-item enabled"><input class="task-list-item-checkbox" checked=""type="checkbox"> 存储用户信息</li>
<li class="task-list-item enabled"><input class="task-list-item-checkbox" checked=""type="checkbox"> 用户登录注册验证</li>
<li class="task-list-item enabled"><input class="task-list-item-checkbox" checked=""type="checkbox"> 消息中转分发</li>
<li class="task-list-item enabled"><input class="task-list-item-checkbox" checked=""type="checkbox"> 用户权限管理</li>
<li class="task-list-item enabled"><input class="task-list-item-checkbox" checked=""type="checkbox"> 指令控制</li>
<li class="task-list-item enabled"><input class="task-list-item-checkbox" checked=""type="checkbox"> 消息存储</li>
</ol>
<h3 id="32-客户端">3.2 客户端</h3>
<ol class="contains-task-list">
<li class="task-list-item enabled"><input class="task-list-item-checkbox" checked=""type="checkbox"> 连接指定服务器</li>
<li class="task-list-item enabled"><input class="task-list-item-checkbox" checked=""type="checkbox"> 登录注册</li>
<li class="task-list-item enabled"><input class="task-list-item-checkbox" checked=""type="checkbox"> 查看在线用户</li>
<li class="task-list-item enabled"><input class="task-list-item-checkbox" checked=""type="checkbox"> 发送接收信息</li>
<li class="task-list-item enabled"><input class="task-list-item-checkbox"type="checkbox"> 头像显示</li>
</ol>
<hr>
<h2 id="4-逻辑思想">4. 逻辑思想</h2>
<h3 id="41-注册">4.1 注册</h3>
<details><summary><mark>点击查看流程图</mark></summary>
<p><img src="file:///d:\Desktop\Code\VS2022\Chatting_Room\Src\%E6%B3%A8%E5%86%8C.drawio.png" alt="注册"></p>
</details>
<h3 id="42-登录">4.2 登录</h3>
<details><summary><mark>点击查看流程图</mark></summary>
<p><img src="file:///d:\Desktop\Code\VS2022\Chatting_Room\Src\%E7%99%BB%E5%BD%95.drawio.png" alt="登录"></p>
</details>
<h3 id="43-聊天">4.3 聊天</h3>
<details><summary><mark>点击查看流程图</mark></summary>
<p><img src="file:///d:\Desktop\Code\VS2022\Chatting_Room\Src\%E8%81%8A%E5%A4%A9.drawio.png" alt="聊天"></p>
</details>
<hr>

            
            
        </body>
        </html>